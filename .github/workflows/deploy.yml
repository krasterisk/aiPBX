name: Deploy to Production
on:
  push:
    branches: [main]
    paths-ignore:
      - "*.md"
      - ".docs/**"
      - ".loki/**"
  # Ручной запуск с выбором сервера
  workflow_dispatch:
    inputs:
      target:
        description: "Deploy target"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - production-1
          - production-2
          - production-3
env:
  REGISTRY: ghcr.io
  IMAGE_PREFIX: ${{ github.repository }}
jobs:
  # ─── Step 1: Lint & Test ─────────────
  quality:
    name: Quality Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"
      - run: npm ci
      - run: npm run lint:ts
      - run: npm run lint:scss
      - run: npm run test:unit -- --ci --coverage
  # ─── Step 0: Determine which servers to deploy ──
  prepare:
    name: Prepare Deploy Matrix
    runs-on: ubuntu-latest
    outputs:
      servers: ${{ steps.set-matrix.outputs.servers }}
    steps:
      - name: Set server matrix
        id: set-matrix
        run: |
          if [[ "${{ github.event_name }}" == "push" || "${{ github.event.inputs.target }}" == "all" ]]; then
            echo 'servers=["aipbxnet_production"]' >> $GITHUB_OUTPUT
          else
            echo 'servers=["${{ github.event.inputs.target }}"]' >> $GITHUB_OUTPUT
          fi
  # ─── Step 2: Build & Push per-server Frontend Images ─
  build:
    name: Build (${{ matrix.server }})
    needs: [quality, prepare]
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        server: ${{ fromJSON(needs.prepare.outputs.servers) }}
    environment: ${{ matrix.server }}
    steps:
      - uses: actions/checkout@v4
      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Build & Push Frontend
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend-${{ matrix.server }}:latest
            ${{ env.REGISTRY }}/${{ env.IMAGE_PREFIX }}/frontend-${{ matrix.server }}:${{ github.sha }}
          build-args: |
            API_URL=${{ secrets.FRONTEND_API_URL }}
            STATIC_URL=${{ secrets.FRONTEND_STATIC_URL }}
            PORT=7003
            TG_BOT_ID=${{ secrets.TG_BOT_ID }}
            STRIPE_PUBLISHABLE_KEY=${{ secrets.FRONTEND_STRIPE_KEY }}
          cache-from: type=gha,scope=${{ matrix.server }}
          cache-to: type=gha,scope=${{ matrix.server }},mode=max
  # ─── Step 3: Deploy to all servers ───
  deploy:
    name: Deploy (${{ matrix.server }})
    needs: [build, prepare]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        server: ${{ fromJSON(needs.prepare.outputs.servers) }}
      fail-fast: false  # Не останавливать остальные при ошибке на одном
    environment: ${{ matrix.server }}
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /app
            # Pull latest images
            docker compose -f docker-compose.production.yml pull
            # Rolling update (zero-downtime)
            docker compose -f docker-compose.production.yml up -d \
              --remove-orphans \
              --force-recreate frontend backend
            # Wait for health checks
            sleep 10
            # Verify deployment
            curl -sf http://localhost/api/health || exit 1
            # Cleanup old images
            docker image prune -f
            echo "✅ Deployment to ${{ matrix.server }} successful!"
      - name: Notify on failure
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: "Deploy to ${{ matrix.server }} failed!"
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK }}