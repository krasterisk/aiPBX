name: Deploy to Production

on:
  push:
    branches: [master]
    paths-ignore:
      - "*.md"
      - ".docs/**"
      - ".loki/**"
      - ".agent/**"
  # Ручной запуск с выбором сервера
  workflow_dispatch:
    inputs:
      target:
        description: "Deploy target"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - aipbxnet_production
          - aipbxorg_production
          - aipbxru_production

jobs:
  # ─── Step 1: Lint & Test ─────────────
  quality:
    name: Quality Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"
      - run: npm ci
      - run: npm run lint:ts
      # - run: npm run lint:scss

  # ─── Step 2: Determine which servers to deploy ──
  prepare:
    name: Prepare Deploy Matrix
    runs-on: ubuntu-latest
    outputs:
      servers: ${{ steps.set-matrix.outputs.servers }}
    steps:
      - name: Set server matrix
        id: set-matrix
        run: |
          # Ручной запуск — используем выбранный target
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ github.event.inputs.target }}" == "all" ]]; then
              echo 'servers=["aipbxnet_production","aipbxorg_production","aipbxru_production"]' >> $GITHUB_OUTPUT
            else
              echo 'servers=["${{ github.event.inputs.target }}"]' >> $GITHUB_OUTPUT
            fi
            exit 0
          fi

          # Push — парсим commit message
          MSG="${{ github.event.head_commit.message }}"

          if [[ "$MSG" == *"[deploy all]"* ]]; then
            echo "Deploy to all servers"
            echo 'servers=["aipbxnet_production","aipbxorg_production","aipbxru_production"]' >> $GITHUB_OUTPUT
          elif [[ "$MSG" == *"[deploy:1]"* ]]; then
            echo "Deploy only to aipbxnet"
            echo 'servers=["aipbxnet_production"]' >> $GITHUB_OUTPUT
          elif [[ "$MSG" == *"[deploy:2]"* ]]; then
            echo "Deploy only to aipbxorg"
            echo 'servers=["aipbxorg_production"]' >> $GITHUB_OUTPUT
          elif [[ "$MSG" == *"[deploy:3]"* ]]; then
            echo "Deploy only to aipbxru"
            echo 'servers=["aipbxru_production"]' >> $GITHUB_OUTPUT
          else
            echo "No deploy tag found — skipping deployment"
            echo 'servers=[]' >> $GITHUB_OUTPUT
          fi

  # ─── Step 3: Deploy to servers ───────
  deploy:
    name: Deploy (${{ matrix.server }})
    needs: [quality, prepare]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        server: ${{ fromJSON(needs.prepare.outputs.servers) }}
      fail-fast: false
    environment: ${{ matrix.server }}
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            set -e
            echo "Starting deployment to ${{ matrix.server }}..."

            cd /app

            # ── Mark repo as safe (Git 2.35.2+ ownership check) ──
            git config --global --add safe.directory /app/aiPBX

            # ── Fix ownership so current user can pull and deploy ──
            sudo chown -R $(whoami) /app/aiPBX
            sudo chown $(whoami) /app/.env.production /app/docker-compose.production.yml

            # ── Pull latest code ──
            echo "Pulling frontend..."
            cd /app/aiPBX && git pull origin master

            cd /app

            # ── Build & deploy ──
            echo "Building and deploying frontend..."
            sudo docker compose -f docker-compose.production.yml --env-file .env.production up -d \
              --build \
              --force-recreate frontend \
              --remove-orphans

            # ── Wait for startup ──
            echo "Waiting for services to start..."
            sleep 10

            # ── Verify deployment ──
            echo "Checking containers..."
            sudo docker compose -f docker-compose.production.yml --env-file .env.production ps frontend

            # ── Cleanup ──
            sudo docker image prune -f
            echo "Deployment to ${{ matrix.server }} successful!"