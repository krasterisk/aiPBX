name: Deploy to Production

on:
  push:
    branches: [master]
    paths-ignore:
      - "*.md"
      - ".docs/**"
      - ".loki/**"
      - ".agent/**"
  # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº Ñ Ğ²Ñ‹Ğ±Ğ¾Ñ€Ğ¾Ğ¼ ÑĞµÑ€Ğ²ĞµÑ€Ğ°
  workflow_dispatch:
    inputs:
      target:
        description: "Deploy target"
        required: true
        default: "all"
        type: choice
        options:
          - all
          - aipbxnet_production
          - aipbxorg_production
          - aipbxru_production

jobs:
  # â”€â”€â”€ Step 1: Lint & Test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  quality:
    name: ğŸ” Quality Checks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: "npm"
      - run: npm ci
      - run: npm run lint:ts
      # - run: npm run lint:scss

  # â”€â”€â”€ Step 2: Determine which servers to deploy â”€â”€
  prepare:
    name: ğŸ“‹ Prepare Deploy Matrix
    runs-on: ubuntu-latest
    outputs:
      servers: ${{ steps.set-matrix.outputs.servers }}
    steps:
      - name: Set server matrix
        id: set-matrix
        run: |
          # Ğ ÑƒÑ‡Ğ½Ğ¾Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº â€” Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµĞ¼ Ğ²Ñ‹Ğ±Ñ€Ğ°Ğ½Ğ½Ñ‹Ğ¹ target
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            if [[ "${{ github.event.inputs.target }}" == "all" ]]; then
              echo 'servers=["aipbxnet_production","aipbxorg_production","aipbxru_production"]' >> $GITHUB_OUTPUT
            else
              echo 'servers=["${{ github.event.inputs.target }}"]' >> $GITHUB_OUTPUT
            fi
            exit 0
          fi

          # Push â€” Ğ¿Ğ°Ñ€ÑĞ¸Ğ¼ commit message
          MSG="${{ github.event.head_commit.message }}"

          if [[ "$MSG" == *"[skip deploy]"* ]]; then
            echo "â­ï¸ Deploy skipped by commit message"
            echo 'servers=[]' >> $GITHUB_OUTPUT
          elif [[ "$MSG" == *"[deploy:1]"* ]]; then
            echo "ğŸ¯ Deploy only to production-1"
            echo 'servers=["aipbxnet_production"]' >> $GITHUB_OUTPUT
          elif [[ "$MSG" == *"[deploy:2]"* ]]; then
            echo "ğŸ¯ Deploy only to production-2"
            echo 'servers=["aipbxorg_production"]' >> $GITHUB_OUTPUT
          elif [[ "$MSG" == *"[deploy:3]"* ]]; then
            echo "ğŸ¯ Deploy only to production-3"
            echo 'servers=["aipbxru_production"]' >> $GITHUB_OUTPUT
          else
            echo "ğŸŒ Deploy to all servers"
            echo 'servers=["aipbxnet_production","aipbxorg_production","aipbxru_production"]' >> $GITHUB_OUTPUT
          fi

  # â”€â”€â”€ Step 3: Deploy to servers â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: ğŸš€ Deploy (${{ matrix.server }})
    needs: [quality, prepare]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        server: ${{ fromJSON(needs.prepare.outputs.servers) }}
      fail-fast: false
    environment: ${{ matrix.server }}
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script_stop: true
          script: |
            set -e
            echo "ğŸš€ Starting deployment to ${{ matrix.server }}..."

            cd /app

            # â”€â”€ Pull latest code â”€â”€
            echo "ğŸ“¥ Pulling frontend..."
            cd /app/aiPBX && git pull origin master

            echo "ğŸ“¥ Pulling backend..."
            cd /app/aiPBX_backend && git pull origin master

            cd /app

            # â”€â”€ Build & deploy â”€â”€
            echo "ğŸ”¨ Building and deploying..."
            docker compose -f docker-compose.production.yml --env-file .env.production up -d \
              --build \
              --force-recreate frontend backend \
              --remove-orphans

            # â”€â”€ Wait for health checks â”€â”€
            echo "â³ Waiting for services to start..."
            sleep 15

            # â”€â”€ Verify deployment â”€â”€
            echo "ğŸ¥ Checking health..."
            if curl -sf --max-time 10 http://localhost/api/health > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
            else
              echo "âš ï¸ Health check failed, checking containers..."
              docker compose -f docker-compose.production.yml ps
              docker compose -f docker-compose.production.yml logs --tail=50 backend
              exit 1
            fi

            # â”€â”€ Cleanup â”€â”€
            docker image prune -f
            echo "âœ… Deployment to ${{ matrix.server }} successful!"