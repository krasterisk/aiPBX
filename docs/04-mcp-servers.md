# 🔌 MCP Серверы — интеграции с внешними сервисами

> MCP (Model Context Protocol) Серверы позволяют ассистенту взаимодействовать с **сотнями внешних сервисов** — Gmail, Google Calendar, Telegram, Bitrix24, Slack, Notion и многими другими. Подключите сервис один раз, и ассистент сможет использовать его инструменты в разговоре.

---

## Содержание

1. [Что такое MCP?](#что-такое-mcp)
2. [Галерея интеграций (Composio)](#галерея-интеграций-composio)
3. [Подключение MCP сервера](#подключение-mcp-сервера)
4. [Форма настройки MCP сервера](#форма-настройки-mcp-сервера)
5. [Управление инструментами](#управление-инструментами)
6. [Собственный MCP сервер](#собственный-mcp-сервер)
7. [Привязка к ассистенту](#привязка-к-ассистенту)

---

## Что такое MCP?

**MCP (Model Context Protocol)** — это открытый стандарт, который позволяет ИИ подключаться к внешним сервисам через единый протокол. Думайте об MCP как о «USB для ИИ» — универсальный разъём, через который можно подключить любой инструмент.

### Как это работает?

```
┌──────────────┐     MCP      ┌──────────────┐     API      ┌──────────────┐
│  Ассистент   │ ──────────→ │  MCP Сервер  │ ──────────→ │  Gmail,      │
│  (AI PBX)    │ ←────────── │  (посредник)  │ ←────────── │  Calendar,   │
│              │   Ответ     │              │   Данные    │  Telegram... │
└──────────────┘              └──────────────┘              └──────────────┘
```

**Без MCP:** Вам нужно для каждого сервиса писать свой webhook, разбираться с API, обрабатывать ответы.

**С MCP:** Подключаете готовый MCP сервер, и ассистент сразу получает набор инструментов — отправить письмо, создать событие, написать в чат.

---

## Галерея интеграций (Composio)

AI PBX интегрируется с **Composio** — платформой, которая предоставляет готовые MCP серверы для 250+ сервисов.

```
┌──────────────────────────────────────────────────────────────────────────┐
│  🔌 MCP Серверы — Галерея                              ┌────────────┐  │
│                                                         │ Мои серверы│  │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐      └────────────┘  │
│  │  📧 Gmail    │ │ 📅 Google   │ │ 📋 Google   │                      │
│  │             │ │  Calendar   │ │  Sheets     │                      │
│  │  ✅ Connected │ │  Подключить │ │  Подключить │                      │
│  └─────────────┘ └─────────────┘ └─────────────┘                      │
│                                                                        │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                      │
│  │  💬 Slack    │ │ 📝 Notion   │ │ 📊 Bitrix24 │                      │
│  │             │ │             │ │             │                      │
│  │  Подключить │ │  Подключить │ │  Подключить │                      │
│  └─────────────┘ └─────────────┘ └─────────────┘                      │
│                                                                        │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐                      │
│  │  💬 Telegram │ │  📞 WhatsApp│ │ 📧 Outlook  │                      │
│  │             │ │             │ │             │                      │
│  │  ✅ Connected │ │  Подключить │ │  Подключить │                      │
│  └─────────────┘ └─────────────┘ └─────────────┘                      │
│                                                                        │
│  ... и 250+ других сервисов                                            │
└──────────────────────────────────────────────────────────────────────────┘
```

### Процесс подключения через Composio

1. **Выберите сервис** из галереи (например, Gmail)
2. **Нажмите «Подключить»** — откроется окно авторизации сервиса
3. **Авторизуйтесь** в сервисе (Google просит войти и дать разрешения)
4. **Готово!** — MCP сервер создан. Его инструменты сразу доступны ассистенту

```
┌──────────────────────────────────────────────────────┐
│  🔗 Подключение Gmail                                │
│                                                      │
│  ┌────────────────────────────────────────────┐      │
│  │                                            │      │
│  │     Google хочет убедиться, что это вы     │      │
│  │                                            │      │
│  │     📧 your@gmail.com                      │      │
│  │                                            │      │
│  │     AI PBX хочет получить доступ к:        │      │
│  │     ☑ Читать почту                         │      │
│  │     ☑ Отправлять письма                    │      │
│  │     ☑ Управлять ярлыками                   │      │
│  │                                            │      │
│  │     ┌────────────┐  ┌──────────────────┐   │      │
│  │     │  Отмена     │  │   Разрешить      │   │      │
│  │     └────────────┘  └──────────────────┘   │      │
│  │                                            │      │
│  └────────────────────────────────────────────┘      │
└──────────────────────────────────────────────────────┘
```

---

## Подключение MCP сервера

### Два способа создания

1. **Из галереи Composio** — выбрать готовый сервис (Gmail, Slack, etc.)
2. **Вручную** — указать адрес собственного MCP сервера

### Создание вручную

Нажмите **«Мои серверы» → ＋** для создания нового MCP сервера.

---

## Форма настройки MCP сервера

```
┌─────────────────────────────────────────────────────────────────────────┐
│  🔌 MCP Сервер — настройка                          💾 Сохранить  ✕   │
│─────────────────────────────────────────────────────────────────────────│
│                                                                         │
│  ┌──── Основные настройки ─────────┐  ┌──── Подключение ─────────────┐ │
│  │                                  │  │                              │ │
│  │  Наименование                    │  │  Адрес сервера (SSE URL)     │ │
│  │  ┌──────────────────────────┐   │  │  ┌──────────────────────┐   │ │
│  │  │ Мой Telegram бот         │   │  │  │ https://mcp.example  │   │ │
│  │  └──────────────────────────┘   │  │  │ .com/sse             │   │ │
│  │                                  │  │  └──────────────────────┘   │ │
│  │  Описание                        │  │                              │ │
│  │  ┌──────────────────────────┐   │  │  Тип аутентификации          │ │
│  │  │ Отправляет уведомления   │   │  │  ┌──────────────────────┐   │ │
│  │  │ о новых заявках          │   │  │  │ Bearer Token       ▾ │   │ │
│  │  └──────────────────────────┘   │  │  └──────────────────────┘   │ │
│  │                                  │  │                              │ │
│  │                                  │  │  API Key / Token             │ │
│  │                                  │  │  ┌──────────────────────┐   │ │
│  │                                  │  │  │ sk-xxxxxxxxxxxxx     │   │ │
│  │                                  │  │  └──────────────────────┘   │ │
│  │                                  │  │                              │ │
│  │                                  │  │  Для Telegram бота:         │ │
│  │                                  │  │  Chat ID                     │ │
│  │                                  │  │  ┌──────────────────────┐   │ │
│  │                                  │  │  │ 123456789            │   │ │
│  │                                  │  │  └──────────────────────┘   │ │
│  │                                  │  │                              │ │
│  │                                  │  │  ┌──────────────────────┐   │ │
│  │                                  │  │  │  🔗 Подключиться     │   │ │
│  │                                  │  │  └──────────────────────┘   │ │
│  │                                  │  │                              │ │
│  │                                  │  │  Статус: ✅ Подключено      │ │
│  └──────────────────────────────────┘  └──────────────────────────────┘ │
│                                                                         │
│  ┌──── Инструменты ──────────────────────────────────────────────────┐ │
│  │                                                                    │ │
│  │  ☑ send_message      — Отправить сообщение в Telegram             │ │
│  │  ☑ get_updates       — Получить новые сообщения                   │ │
│  │  ☐ edit_message      — Редактировать отправленное сообщение       │ │
│  │  ☐ send_photo        — Отправить фото                             │ │
│  │                                                                    │ │
│  │  ┌────────────────────────────────────────────────┐                │ │
│  │  │         🔄 Синхронизировать инструменты         │                │ │
│  │  └────────────────────────────────────────────────┘                │ │
│  └────────────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────────┘
```

### Поля формы

| Поле | Описание |
|------|----------|
| **Наименование** | Понятное имя для внутреннего использования |
| **Описание** | Описание назначения сервера |
| **Адрес сервера (SSE URL)** | URL-адрес MCP сервера. Протокол SSE (Server-Sent Events) — для двусторонней связи |
| **Тип аутентификации** | `None`, `Bearer Token`, `Basic Auth` или `Chat ID` (для Telegram) |
| **API Key / Token** | Ключ или токен для авторизации |
| **Chat ID** | Для Telegram — ID чата, куда отправлять уведомления |

---

## Управление инструментами

После подключения MCP сервера вы видите список **инструментов**, которые он предоставляет. Каждый инструмент — это конкретное действие, которое ассистент может выполнить.

### Синхронизация

Нажмите **«🔄 Синхронизировать инструменты»**, чтобы загрузить актуальный список инструментов с MCP сервера. Это нужно делать:
- При первом подключении
- Если на сервере добавились или изменились инструменты

### Включение/выключение

Не все инструменты нужны вашему ассистенту. Галочками отметьте только те, которые ему понадобятся:

```
☑ send_message       — Ассистент сможет отправлять сообщения
☐ delete_message      — Ассистент НЕ сможет удалять сообщения
```

> 💡 **Совет:** Чем меньше инструментов подключено одновременно, тем точнее ИИ выбирает нужный. Не включайте всё подряд — только то, что реально нужно.

### Просмотр деталей инструмента

Нажмите на инструмент, чтобы увидеть его параметры:

```
┌──────────────────────────────────────────────────────┐
│  📋 send_message                                     │
│                                                      │
│  Описание: Отправляет текстовое сообщение в          │
│  указанный Telegram чат.                             │
│                                                      │
│  Параметры:                                          │
│  ├─ chat_id (string, обязательный)                   │
│  │  ID чата для отправки                              │
│  ├─ text (string, обязательный)                       │
│  │  Текст сообщения                                   │
│  └─ parse_mode (string, необязательный)               │
│     Формат: HTML, Markdown или plain text             │
│                                                      │
│  ┌────────────────────────────────────────────┐      │
│  │         ▶ Тестировать инструмент            │      │
│  └────────────────────────────────────────────┘      │
└──────────────────────────────────────────────────────┘
```

### Тестирование инструмента

Вы можете протестировать каждый инструмент прямо из интерфейса, не подключая его к ассистенту:

```
┌──────────────────────────────────────────────────────┐
│  🧪 Тестирование: send_message                       │
│                                                      │
│  Входные параметры (JSON):                           │
│  ┌──────────────────────────────────────────────┐    │
│  │ {                                            │    │
│  │   "chat_id": "123456789",                    │    │
│  │   "text": "Тестовое сообщение!"              │    │
│  │ }                                            │    │
│  └──────────────────────────────────────────────┘    │
│                                                      │
│  ┌────────────────────────────────────────────┐      │
│  │            ▶ Выполнить                      │      │
│  └────────────────────────────────────────────┘      │
│                                                      │
│  Результат:                                          │
│  ┌──────────────────────────────────────────────┐    │
│  │ ✅ Успешно                                    │    │
│  │ { "ok": true, "message_id": 42 }             │    │
│  └──────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────┘
```

---

## Собственный MCP сервер

Вы можете подключить **свой MCP сервер**, разработанный по стандарту MCP.

### Требования

1. Сервер должен поддерживать **SSE (Server-Sent Events)** протокол
2. Иметь доступный URL (HTTPS)
3. Предоставлять список инструментов по запросу `tools/list`
4. Обрабатывать вызовы инструментов по запросу `tools/call`

### Пример на Node.js

```javascript
// Минимальный MCP сервер
import { McpServer } from "@modelcontextprotocol/sdk/server/mcp.js";
import { SSEServerTransport } from "@modelcontextprotocol/sdk/server/sse.js";

const server = new McpServer({
  name: "my-mcp-server",
  version: "1.0.0"
});

// Регистрация инструмента
server.tool("get_weather", { city: "string" }, async ({ city }) => {
  const weather = await fetchWeather(city);
  return { content: [{ type: "text", text: JSON.stringify(weather) }] };
});

// Запуск SSE транспорта
const transport = new SSEServerTransport("/sse", response);
await server.connect(transport);
```

---

## Привязка к ассистенту

Созданные MCP серверы привязываются к ассистенту так же, как функции:

1. Откройте нужного ассистента
2. В карточке **Основные настройки** найдите поле **«MCP Серверы»**
3. Выберите нужные серверы из списка
4. Сохраните

```
┌──────────────────────────────────┐
│  MCP Серверы                     │
│  ┌──────────────────────────┐   │
│  │ Telegram Bot          ✕  │   │
│  │ Google Calendar       ✕  │   │
│  │                          │   │
│  │ Начните вводить...       │   │
│  └──────────────────────────┘   │
└──────────────────────────────────┘
```

Инструменты всех подключённых MCP серверов автоматически становятся доступны ассистенту.

---

## Примеры сценариев

### Сценарий 1: Уведомления о заявках в Telegram

```
Клиент звонит → Ассистент записывает данные →
  → MCP сервер Telegram → send_message →
  → Менеджер получает в Telegram:
    📣 Новая заявка!
    Клиент: Иванов П.С.
    ☎ +7 900 123-45-67
    Проблема: стиральная машина не отжимает
```

### Сценарий 2: Запись в Google Calendar

```
Клиент хочет записаться → Ассистент уточняет дату →
  → MCP сервер Google Calendar → check_availability →
  → Ассистент: «Свободно в 14:00 и 16:30» →
  → Клиент выбирает → create_event →
  → Событие создано в Google Calendar
```

### Сценарий 3: Письмо с подтверждением через Gmail

```
Заказ оформлен → Ассистент спрашивает email →
  → MCP сервер Gmail → send_email →
  → Клиент получает письмо с подтверждением заказа
```

---

*Предыдущий раздел: [🧩 Функции (Tools)](./03-tools.md) • Следующий раздел: [🧪 Песочница →](./05-playground.md)*
