# 🌐 Публикация и интеграция

> После тестирования ассистента в Песочнице, его нужно **опубликовать** — подключить к реальному каналу связи. AI PBX поддерживает три способа: SIP (телефония), WebRTC виджеты (сайт) и прямое подключение к PBX серверу (Asterisk).

---

## Содержание

1. [Способы публикации — обзор](#способы-публикации--обзор)
2. [SIPs — VoIP интеграция](#sips--voip-интеграция)
3. [Виджеты — WebRTC для сайта](#виджеты--webrtc-для-сайта)
4. [PBXs — подключение Asterisk](#pbxs--подключение-asterisk)
5. [Настройка Asterisk](#настройка-asterisk)

---

## Способы публикации — обзор

| Способ | Для кого | Как работает | Сложность |
|--------|---------|-------------|-----------|
| **SIP URI** | Компании с VoIP-телефонией | Ассистент получает SIP-адрес, звонки идут через VoIP | ⭐⭐ |
| **WebRTC Виджет** | Владельцы сайтов | Кнопка «Позвонить» на вашем сайте, звонок из браузера | ⭐ |
| **PBX Сервер** | Компании с Asterisk | Прямое подключение к вашему серверу Asterisk | ⭐⭐⭐ |

```
                    ┌──────────────────┐
                    │   AI PBX Cloud   │
                    │   (Ассистент)    │
                    └───────┬──────────┘
                            │
            ┌───────────────┼───────────────┐
            │               │               │
     ┌──────┴──────┐ ┌──────┴──────┐ ┌──────┴──────┐
     │  SIP URI    │ │  WebRTC     │ │  Asterisk   │
     │  (Телефон)  │ │  (Сайт)    │ │  (PBX)     │
     └─────────────┘ └─────────────┘ └─────────────┘
      📞 VoIP-звонок   🖥️ Браузер     🏢 Офисная АТС
```

---

## SIPs — VoIP интеграция

SIP (Session Initiation Protocol) — это стандарт интернет-телефонии. С помощью SIP URI вы можете подключить ассистента к любой VoIP-линии.

### Создание SIP URI

```
┌──────────────────────────────────────────────────────────────────────────┐
│  📞 SIPs                                                     ┌────┐    │
│                                                               │  ＋ │    │
│  ┌──────────────────────────────────────────────────────────┐└────┘    │
│  │  📞 support-bot                                          │           │
│  │  sip:support-bot@sip.aipbx.com                           │           │
│  │  🤖 Бот поддержки клиентов                               │           │
│  └──────────────────────────────────────────────────────────┘           │
│                                                                          │
│  ┌──────────────────────────────────────────────────────────┐           │
│  │  📞 pizza-order                                          │           │
│  │  sip:pizza-order@sip.aipbx.com                           │           │
│  │  🤖 Оператор пиццерии                                    │           │
│  └──────────────────────────────────────────────────────────┘           │
└──────────────────────────────────────────────────────────────────────────┘
```

### Форма SIP

```
┌──────────────────────────────────────────────────────┐
│  📞 Создать SIP URI                     💾  ✕       │
│──────────────────────────────────────────────────────│
│                                                      │
│  SIP URI                                             │
│  ┌──────────────────────────────────────────────┐    │
│  │ support-bot                                  │    │
│  └──────────────────────────────────────────────┘    │
│  → sip:support-bot@sip.aipbx.com                     │
│                                                      │
│  Пароль                                              │
│  ┌──────────────────────────────────────────────┐    │
│  │ ••••••••••                                   │    │
│  └──────────────────────────────────────────────┘    │
│                                                      │
│  Ассистент                                           │
│  ┌──────────────────────────────────────────────┐    │
│  │ Бот поддержки клиентов                    ▾  │    │
│  └──────────────────────────────────────────────┘    │
│                                                      │
│  Контекст (Dialplan)                                 │
│  ┌──────────────────────────────────────────────┐    │
│  │ assistant-in                                 │    │
│  └──────────────────────────────────────────────┘    │
│                                                      │
│  Комментарий                                         │
│  ┌──────────────────────────────────────────────┐    │
│  │ Основная линия техподдержки                  │    │
│  └──────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────┘
```

### Поля SIP формы

| Поле | Описание |
|------|----------|
| **SIP URI** | Уникальный идентификатор. Будет частью SIP-адреса: `sip:{ваш-id}@sip.aipbx.com` |
| **Пароль** | Пароль для SIP-регистрации |
| **Ассистент** | Какой ассистент будет отвечать на звонки по этой линии |
| **Контекст** | Контекст диалплана Asterisk. Обычно `assistant-in` |
| **Комментарий** | Внутренняя заметка |

### Как использовать SIP URI

1. **Создайте SIP URI** в AI PBX
2. **Настройте маршрутизацию** на вашей АТС — входящие звонки направляйте на SIP-адрес ассистента
3. **Тестируйте** — позвоните на настроенный номер

> 📌 **Примечание:** SIP URI работает с любой VoIP-системой, поддерживающей стандарт SIP: Asterisk, FreePBX, 3CX, Yeastar и др.

---

## Виджеты — WebRTC для сайта

Виджет — это кнопка «Позвонить», встроенная в ваш сайт. Клиент нажимает — и начинает разговор с ассистентом прямо из браузера, без установки приложений и без регистрации.

### Создание виджета

```
┌──────────────────────────────────────────────────────────────────────────┐
│  🌐 Виджеты                                                  ┌────┐    │
│                                                               │  ＋ │    │
│  ┌──────────────────────────────────────────────────────────┐└────┘    │
│  │  🌐 Виджет сайта — ТехноМастер                           │           │
│  │  ID: widget-abc123                                        │           │
│  │  🤖 Бот поддержки клиентов                               │           │
│  └──────────────────────────────────────────────────────────┘           │
└──────────────────────────────────────────────────────────────────────────┘
```

### Форма виджета

```
┌──────────────────────────────────────────────────────┐
│  🌐 Создать виджет                      💾  ✕       │
│──────────────────────────────────────────────────────│
│                                                      │
│  Наименование                                        │
│  ┌──────────────────────────────────────────────┐    │
│  │ Виджет для сайта ТехноМастер                 │    │
│  └──────────────────────────────────────────────┘    │
│                                                      │
│  Ассистент                                           │
│  ┌──────────────────────────────────────────────┐    │
│  │ Бот поддержки клиентов                    ▾  │    │
│  └──────────────────────────────────────────────┘    │
│                                                      │
│  SIP URI для WebRTC                                  │
│  ┌──────────────────────────────────────────────┐    │
│  │ support-webrtc                               │    │
│  └──────────────────────────────────────────────┘    │
│                                                      │
│  Код для встраивания:                                │
│  ┌──────────────────────────────────────────────┐    │
│  │ <script src="https://aipbx.com/widget/       │    │
│  │   widget-abc123.js"></script>                 │    │
│  │                                              │    │
│  │                              📋 Копировать    │    │
│  └──────────────────────────────────────────────┘    │
│                                                      │
│  Комментарий                                         │
│  ┌──────────────────────────────────────────────┐    │
│  │ Для главной страницы сайта                   │    │
│  └──────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────┘
```

### Как встроить виджет на сайт

1. **Создайте виджет** в AI PBX, выберите ассистента
2. **Скопируйте код** из поля «Код для встраивания»
3. **Вставьте код** в HTML вашего сайта перед закрывающим тегом `</body>`:

```html
<!-- AI PBX Widget -->
<script src="https://aipbx.com/widget/widget-abc123.js"></script>
```

4. **Готово!** На сайте появится кнопка вызова

```
┌──────────────────────────────────────────────────────┐
│                                                      │
│              Ваш сайт                                │
│                                                      │
│    Добро пожаловать в ТехноМастер!                   │
│    Мы ремонтируем бытовую технику                    │
│                                                      │
│                                                      │
│                                          ┌─────────┐ │
│                                          │  📞     │ │
│                                          │ Звонок  │ │
│                                          └─────────┘ │
│                                                      │
└──────────────────────────────────────────────────────┘
```

> 💡 **Совет:** Виджет работает через WebRTC — нужен только браузер и микрофон. Никаких плагинов или установок.

---

## PBXs — подключение Asterisk

Если у вас собственный сервер **Asterisk**, вы можете подключить его напрямую к AI PBX. Это даёт полный контроль над маршрутизацией звонков.

### Создание PBX подключения

```
┌──────────────────────────────────────────────────────┐
│  🏢 Создать PBX                         💾  ✕       │
│──────────────────────────────────────────────────────│
│                                                      │
│  Наименование                                        │
│  ┌──────────────────────────────────────────────┐    │
│  │ Офис Москва                                  │    │
│  └──────────────────────────────────────────────┘    │
│                                                      │
│  WebSocket URL (WSS)                                 │
│  ┌──────────────────────────────────────────────┐    │
│  │ wss://your-asterisk.com:8089/ws              │    │
│  └──────────────────────────────────────────────┘    │
│                                                      │
│  ARI URL                                             │
│  ┌──────────────────────────────────────────────┐    │
│  │ https://your-asterisk.com:8089               │    │
│  └──────────────────────────────────────────────┘    │
│                                                      │
│  ARI Логин                                           │
│  ┌──────────────────────────────────────────────┐    │
│  │ asterisk                                     │    │
│  └──────────────────────────────────────────────┘    │
│                                                      │
│  ARI Пароль                                          │
│  ┌──────────────────────────────────────────────┐    │
│  │ ••••••••                                     │    │
│  └──────────────────────────────────────────────┘    │
│                                                      │
│  Контекст (Dialplan)                                 │
│  ┌──────────────────────────────────────────────┐    │
│  │ assistant-in                                 │    │
│  └──────────────────────────────────────────────┘    │
│                                                      │
│  Комментарий                                         │
│  ┌──────────────────────────────────────────────┐    │
│  │ Основной офис                                │    │
│  └──────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────┘
```

### Поля PBX формы

| Поле | Описание |
|------|----------|
| **WebSocket URL** | WSS-адрес вашего Asterisk для двусторонней связи. Формат: `wss://host:8089/ws` |
| **ARI URL** | HTTP-адрес Asterisk REST Interface для управления звонками |
| **ARI Логин/Пароль** | Учётные данные ARI (настраиваются в Asterisk) |
| **Контекст** | Контекст диалплана, который обрабатывает входящие звонки к ассистенту |

---

## Настройка Asterisk

> ⚠️ Этот раздел для системных администраторов, знакомых с Asterisk.

### 1. Настройка ARI (`ari.conf`)

ARI (Asterisk REST Interface) — это HTTP API для управления звонками. AI PBX использует ARI для получения аудио и отправки ответов.

```ini
; /etc/asterisk/ari.conf

[general]
enabled = yes
pretty = yes

[username]
type = user
read_only = no
password = your_password
password_format = plain
```

### 2. Настройка HTTP (`http.conf`)

Включите HTTP-сервер и WebSocket:

```ini
; /etc/asterisk/http.conf

[general]
enabled = yes
bindaddr = 0.0.0.0
bindport = 8088
tlsenable = yes
tlsbindaddr = 0.0.0.0:8089
tlscertfile = /etc/asterisk/keys/asterisk.pem
tlsprivatekey = /etc/asterisk/keys/asterisk.pem
```

> 📌 TLS обязателен! WebSocket работает через WSS (WebSocket Secure).

### 3. Настройка PJSIP (`pjsip.conf`)

Создайте WebSocket транспорт и endpoint:

```ini
; /etc/asterisk/pjsip.conf

[transport-wss]
type = transport
protocol = wss
bind = 0.0.0.0

[endpoint-name]
type = endpoint
context = from-external
disallow = all
allow = ulaw,alaw,opus
webrtc = yes
dtls_auto_self_generated = yes
```

### 4. Настройка Dialplan (`extensions.conf`)

Создайте контекст для обработки звонков ассистентом:

```ini
; /etc/asterisk/extensions.conf

[assistant-in]
exten => 100,1,NoOp()
same => n,Set(__fname=/usr/records/assistants/${UNIQUEID})
same => n,MixMonitor(${fname}.wav)
same => n,Stasis(aiPBXBot,${ASSISTANTID})
same => n,Hangup()
```

**Что делает каждая строка:**

| Строка | Действие |
|--------|---------|
| `NoOp()` | Пустая операция (для логирования) |
| `Set(__fname=...)` | Устанавливает путь для записи |
| `MixMonitor(...)` | Включает запись разговора |
| `Stasis(aiPBXBot,...)` | Передаёт звонок в ARI-приложение AI PBX |
| `Hangup()` | Завершает звонок после обработки |

### 5. Записи разговоров

Записи доступны по URL:

```
https://{{PBX_ADDRESS}}/records/{{ASSISTANTID}}/{{UNIQUEID}}.{{FORMAT}}
```

| Переменная | Описание |
|-----------|----------|
| `PBX_ADDRESS` | Адрес вашего PBX сервера |
| `ASSISTANTID` | ID ассистента в AI PBX |
| `UNIQUEID` | Уникальный ID звонка (генерируется Asterisk) |
| `FORMAT` | Формат файла: `wav` или `mp3` |

> 📌 **Важно:** Убедитесь, что директория `/usr/records/assistants/` существует и имеет права на запись для пользователя Asterisk.

---

## Быстрый чек-лист публикации

### Вариант A: Виджет на сайт (30 секунд)
- [ ] Перейти в «Виджеты» → Создать
- [ ] Выбрать ассистента
- [ ] Скопировать код
- [ ] Вставить на сайт
- [ ] ✅ Готово!

### Вариант B: SIP (5 минут)
- [ ] Перейти в «SIPs» → Создать
- [ ] Указать SIP URI и пароль
- [ ] Выбрать ассистента
- [ ] Настроить маршрутизацию на АТС
- [ ] ✅ Готово!

### Вариант C: Asterisk PBX (30 минут)
- [ ] Настроить ari.conf
- [ ] Настроить http.conf с TLS
- [ ] Настроить pjsip.conf
- [ ] Создать контекст в extensions.conf
- [ ] Создать PBX в AI PBX с WSS и ARI адресами
- [ ] Протестировать звонок
- [ ] ✅ Готово!

---

*Предыдущий раздел: [📊 Dashboards](./06-dashboards.md) • Следующий раздел: [💳 Оплата и биллинг →](./08-payments.md)*
