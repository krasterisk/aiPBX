# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ Sample Rate –≤ Playground Session

## üêõ –ü—Ä–æ–±–ª–µ–º–∞

**–û—à–∏–±–∫–∞:** `AudioContext.CreateMediaStreamSource: Connecting AudioNodes from AudioContexts with different sample-rate is currently not supported`

### –ü—Ä–∏—á–∏–Ω–∞:
1. AudioContext —Å–æ–∑–¥–∞–≤–∞–ª—Å—è —Å `sampleRate: 24000 Hz`
2. MediaStream –æ—Ç –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞ –∏–º–µ–ª –Ω–∞—Ç–∏–≤–Ω—ã–π `sampleRate` —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ (–æ–±—ã—á–Ω–æ 48000 Hz)
3. –ü—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å MediaStreamSource –∫ AudioContext —Å —Ä–∞–∑–Ω—ã–º–∏ sample-rate –≤–æ–∑–Ω–∏–∫–∞–ª–∞ –æ—à–∏–±–∫–∞

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. **–ò–∑–º–µ–Ω–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏** (`usePlaygroundSession.ts`)

**–î–û:**
```typescript
// 1. –°–æ–∑–¥–∞–≤–∞–ª–∏ AudioContext —Å 24kHz
const ctx = new AudioContext({ sampleRate: 24000 })

// 2. –ü–æ–ª—É—á–∞–ª–∏ stream (–º–æ–≥ –±—ã—Ç—å 48kHz)
const stream = await getUserMedia(...)

// 3. –°–æ–∑–¥–∞–≤–∞–ª–∏ source - –û–®–ò–ë–ö–ê –∏–∑-–∑–∞ —Ä–∞–∑–Ω—ã—Ö rate
const source = ctx.createMediaStreamSource(stream)
```

**–ü–û–°–õ–ï:**
```typescript
// 1. –°–ù–ê–ß–ê–õ–ê –ø–æ–ª—É—á–∞–µ–º stream
const stream = await getUserMedia(...)

// 2. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –†–ï–ê–õ–¨–ù–´–ô sampleRate —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
const actualSampleRate = stream.getAudioTracks()[0].getSettings().sampleRate || 48000

// 3. –°–æ–∑–¥–∞–µ–º AudioContext —Å –¢–ï–ú –ñ–ï sampleRate
const ctx = new AudioContext({ sampleRate: actualSampleRate })

// 4. –°–æ–∑–¥–∞–µ–º source - —Ç–µ–ø–µ—Ä—å rates —Å–æ–≤–ø–∞–¥–∞—é—Ç ‚úÖ
const source = ctx.createMediaStreamSource(stream)
```

### 2. **–î–æ–±–∞–≤–ª–µ–Ω —Ä–µ—Å—ç–º–ø–ª–∏–Ω–≥ –≤ AudioWorklet** (`audioWorklet.ts`)

–ü–æ—Å–∫–æ–ª—å–∫—É AudioContext —Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –Ω–∞—Ç–∏–≤–Ω–æ–º sampleRate (–æ–±—ã—á–Ω–æ 48kHz), –∞ OpenAI –æ–∂–∏–¥–∞–µ—Ç 24kHz, –¥–æ–±–∞–≤–ª–µ–Ω —Ä–µ—Å—ç–º–ø–ª–∏–Ω–≥:

```typescript
// –ü–µ—Ä–µ–¥–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ worklet
const worklet = new AudioWorkletNode(ctx, 'audio-input-processor', {
  processorOptions: {
    targetSampleRate: 24000,      // –î–ª—è OpenAI
    sourceSampleRate: actualSampleRate  // –ù–∞—Ç–∏–≤–Ω—ã–π (48kHz)
  }
})
```

**–í AudioWorklet:**
- –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è `resampleRatio = sourceSampleRate / targetSampleRate` (–Ω–∞–ø—Ä–∏–º–µ—Ä, 48000/24000 = 2.0)
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è **–ª–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è** –¥–ª—è —Ä–µ—Å—ç–º–ø–ª–∏–Ω–≥–∞
- –ö–∞–∂–¥—ã–µ 2 —Å—ç–º–ø–ª–∞ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (48kHz) ‚Üí 1 —Å—ç–º–ø–ª —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ (24kHz)

### 3. **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏**

–î–æ–±–∞–≤–ª–µ–Ω—ã –ª–æ–≥–∏ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏:
```typescript
console.log(`[Audio] Requested: 24000Hz, Actual: ${actualSampleRate}Hz`)
console.log(`[AudioWorklet] Resampling: ${sourceSampleRate}Hz -> ${targetSampleRate}Hz`)
```

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –†–µ—Å—ç–º–ø–ª–∏–Ω–≥ (–õ–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è)

```typescript
while (sourcePosition < inputChannel.length) {
  const sourceIndex = Math.floor(sourcePosition)
  const fraction = sourcePosition - sourceIndex
  
  // –ò–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –º–µ–∂–¥—É –¥–≤—É–º—è —Å–æ—Å–µ–¥–Ω–∏–º–∏ —Å—ç–º–ø–ª–∞–º–∏
  const sample = inputChannel[sourceIndex] * (1 - fraction) + 
                 inputChannel[sourceIndex + 1] * fraction
  
  // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Float32 -> Int16
  const val = sample < 0 ? sample * 0x8000 : sample * 0x7FFF
  
  buffer[bufferIndex++] = val
  
  // –®–∞–≥ –≤–ø–µ—Ä–µ–¥ –ø–æ –∏—Å—Ç–æ—á–Ω–∏–∫—É
  sourcePosition += resampleRatio  // –ù–∞–ø—Ä–∏–º–µ—Ä, += 2.0
}
```

### –ü–æ—á–µ–º—É —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç:

1. **–ò–∑–±–µ–≥–∞–µ–º –∫–æ–Ω—Ñ–ª–∏–∫—Ç–∞ sample-rate**: AudioContext –∏ MediaStream –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π rate
2. **–†–µ—Å—ç–º–ø–ª–∏–Ω–≥ –≤ worklet**: –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º 48kHz ‚Üí 24kHz –ø—Ä–æ–≥—Ä–∞–º–º–Ω–æ
3. **–õ–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è**: –ö–∞—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ–µ –¥–ª—è –≥–æ–ª–æ—Å–∞, –Ω–∏–∑–∫–∞—è –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞

## üìä –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

| –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ | Native Rate | Target Rate | Ratio | –†–µ–∑—É–ª—å—Ç–∞—Ç |
|------------|-------------|-------------|-------|-----------|
| MacBook | 48000 Hz | 24000 Hz | 2.0 | ‚úÖ –†–µ—Å—ç–º–ø–ª–∏–Ω–≥ |
| iPhone | 48000 Hz | 24000 Hz | 2.0 | ‚úÖ –†–µ—Å—ç–º–ø–ª–∏–Ω–≥ |
| Android | 48000 Hz | 24000 Hz | 2.0 | ‚úÖ –†–µ—Å—ç–º–ø–ª–∏–Ω–≥ |
| –ù–µ–∫–æ—Ç–æ—Ä—ã–µ USB | 44100 Hz | 24000 Hz | 1.8375 | ‚úÖ –†–µ—Å—ç–º–ø–ª–∏–Ω–≥ |
| –†–µ–¥–∫–æ | 24000 Hz | 24000 Hz | 1.0 | ‚úÖ –ë–µ–∑ —Ä–µ—Å—ç–º–ø–ª–∏–Ω–≥–∞ |

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

- ‚úÖ **–û—à–∏–±–∫–∞ —É—Å—Ç—Ä–∞–Ω–µ–Ω–∞**: AudioContext –∏ MediaStream –∏–º–µ—é—Ç –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π sampleRate
- ‚úÖ **–ö–∞—á–µ—Å—Ç–≤–æ –∑–≤—É–∫–∞**: –õ–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ö–æ—Ä–æ—à–µ–µ –∫–∞—á–µ—Å—Ç–≤–æ –¥–ª—è –≥–æ–ª–æ—Å–∞
- ‚úÖ **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å**: –ù–∏–∑–∫–∞—è –≤—ã—á–∏—Å–ª–∏—Ç–µ–ª—å–Ω–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞
- ‚úÖ **–°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å**: –†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö –∏ –±—Ä–∞—É–∑–µ—Ä–∞—Ö
- ‚úÖ **–û—Ç–ª–∞–¥–∫–∞**: –õ–æ–≥–∏ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∏ —Ü–µ–ª–µ–≤—ã–µ sampleRate

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

### –ü–æ—á–µ–º—É –Ω–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å OfflineAudioContext –¥–ª—è —Ä–µ—Å—ç–º–ø–ª–∏–Ω–≥–∞?
- OfflineAudioContext –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –î–æ–±–∞–≤–ª—è–µ—Ç –∑–∞–¥–µ—Ä–∂–∫—É
- –°–ª–æ–∂–Ω–µ–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Ç–æ–∫–æ–º

### –ü–æ—á–µ–º—É –ª–∏–Ω–µ–π–Ω–∞—è –∏–Ω—Ç–µ—Ä–ø–æ–ª—è—Ü–∏—è, –∞ –Ω–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω–µ–µ (sinc)?
- –î–ª—è –≥–æ–ª–æ—Å–∞ –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏–Ω–µ–π–Ω–æ–π
- Sinc —Ç—Ä–µ–±—É–µ—Ç –±–æ–ª—å—à–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
- –ì–æ–ª–æ—Å –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –≤—ã—Å–æ–∫–∏—Ö —á–∞—Å—Ç–æ—Ç, —Ç—Ä–µ–±—É—é—â–∏—Ö —Å–ª–æ–∂–Ω–æ–π —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏

### –ß—Ç–æ –µ—Å–ª–∏ –±—Ä–∞—É–∑–µ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏—Ç —Ç–æ—á–Ω—ã–π 24kHz?
- –ö–æ–¥ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç `resampleRatio ‚âà 1.0`
- –†–µ—Å—ç–º–ø–ª–∏–Ω–≥ –±—É–¥–µ—Ç –ø—Ä–æ–ø—É—â–µ–Ω (—É—Å–ª–æ–≤–∏–µ `if (Math.abs(ratio - 1.0) < 0.01)`)
- –ü—Ä—è–º–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Float32 ‚Üí Int16

---

**–î–∞—Ç–∞:** 2026-01-22  
**–í–µ—Ä—Å–∏—è:** 2.0  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ
